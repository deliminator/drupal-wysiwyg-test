/* characterpicker-plugin.js is part of Aloha Editor project http://aloha-editor.org
 *
 * Aloha Editor is a WYSIWYG HTML5 inline editing library and editor. 
 * Copyright (c) 2010-2012 Gentics Software GmbH, Vienna, Austria.
 * Contributors http://aloha-editor.org/contribution.php 
 * 
 * Aloha Editor is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or any later version.
 *
 * Aloha Editor is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 * 
 * As an additional permission to the GNU GPL version 2, you may distribute
 * non-source (e.g., minimized or compacted) forms of the Aloha-Editor
 * source code without the copy of the GNU GPL normally required,
 * provided you include this license notice and a URL through which
 * recipients can access the Corresponding Source.
 */

define(["aloha","jquery","aloha/plugin","ui/ui","ui/button","ui/floating","PubSub","i18n!characterpicker/nls/i18n","i18n!aloha/nls/i18n"],function(e,t,n,r,i,s,o,u,a){function h(e){var n=this;n.$node=t('<table class="aloha-character-picker-overlay" unselectable="on" role="dialog"><tbody></tbody></table>'),n.$node.mousedown(function(e){return!1}),n.onSelectCallback=e,n.$tbody=n.$node.find("tbody"),n.$node.appendTo(t("body")),n._initHideOnDocumentClick(),n._initHideOnEsc(),n._initCursorFocus(e),n._initEvents()}function p(e,n){var r=n.offset(),i={top:0,left:0};return"fixed"===s.POSITION_STYLE&&(r.top-=t(window).scrollTop(),r.left-=t(window).scrollLeft()),i.top=e.offset.top+(r.top-e.offset.top),i.left=e.offset.left+(r.left-e.offset.left),i}function d(t){e.activeEditable&&(c.select(),e.execCommand("insertHTML",!1,t))}var f=window.GENTICS,l={},c;return h.prototype={offset:{top:0,left:0},show:function(e){var n=this;n.$node.css(p(n,e)),n.$node.css("position",s.POSITION_STYLE),n.$node.show(),n.$node
.find(".focused").removeClass("focused"),t(n.$node.find("td")[0]).addClass("focused"),n._overlayActive=!0},hide:function(){this.$node.hide(),this._overlayActive=!1},setCharacters:function(e){this._createCharacterButtons(e)},_initHideOnDocumentClick:function(){var e=this;e.$node.click(function(e){e.stopPropagation()});var n=".aloha-icon-characterpicker";t("body").click(function(r){if(!e._overlayActive)return;r.target!==e.$node[0]&&!t(r.target).is(n)&&!t(r.target).find(n).length&&e.hide()})},_initHideOnEsc:function(){var e=this;t(document).keyup(function(t){var n=e.$node.css("display")==="table"&&t.keyCode===27;n&&e.hide()})},_initCursorFocus:function(e){var n=this,r,i,s,o,u,a={13:function(){r=n.$node.find(".focused"),n.hide(),e(r.text())},37:function(){r=n.$node.find(".focused"),s=r.prev().addClass("focused"),s.length>0&&r.removeClass("focused")},38:function(){r=n.$node.find(".focused"),u=r.parent().prev(),u.length>0&&(s=t(u.children()[r.index()]).addClass("focused"),s.length>0&&r.removeClass
("focused"))},39:function(){r=n.$node.find(".focused"),i=r.next().addClass("focused"),i.length>0&&r.removeClass("focused")},40:function(){r=n.$node.find(".focused"),o=r.parent().next(),o.length>0&&(i=t(o.children()[r.index()]).addClass("focused"),i.length>0&&r.removeClass("focused"))}};t(document).keydown(function(e){e.stopPropagation();var t=n.$node.css("display")==="table";if(t){var r=a[e.keyCode];if(r)return r(),!1}})},_initEvents:function(){var t=this;e.bind("aloha-editable-deactivated",function(e,n){t.hide()})},_createCharacterButtons:function(e){var n=this,r=document.createElement("textarea");r.innerHTML=e,e=r.value;var i=t.grep(e.split(" "),function(t){return t!==""}),s=["<tr>"],o=0,u;while(u=i[o])0!==o&&o%15===0&&s.push("</tr><tr>"),s.push('<td unselectable="on">'+u+"</td>"),o++;s.push("</tr>"),n.$tbody.empty().append(s.join("")),n.$node.delegate("td","mouseover",function(){t(this).addClass("mouseover")}).delegate("td","mouseout",function(){t(this).removeClass("mouseover")}).delegate
("td","click",function(e){n.$node.hide();var r=t(this).text();n.onSelectCallback(r)})}},n.create("characterpicker",{_constructor:function(){this._super("characterpicker")},config:"&#38; &#34; &#162; &#8364; &#163; &#165; &#169; &#174; &#8482; &#8240; &#181; &#183; &#8226; &#8230; &#8242; &#8243; &#167; &#182; &#223; &#8249; &#8250; &#171; &#187; &#8216; &#8217; &#8220; &#8221; &#8218; &#8222; &#60; &#62; &#8804; &#8805; &#8211; &#8212; &#175; &#8254; &#164; &#166; &#168; &#161; &#191; &#710; &#732; &#176; &#8722; &#177; &#247; &#8260; &#215; &#185; &#178; &#179; &#188; &#189; &#190; &#402; &#8747; &#8721; &#8734; &#8730; &#8764; &#8773; &#8776; &#8800; &#8801; &#8712; &#8713; &#8715; &#8719; &#8743; &#8744; &#172; &#8745; &#8746; &#8706; &#8704; &#8707; &#8709; &#8711; &#8727; &#8733; &#8736; &#180; &#184; &#170; &#186; &#8224; &#8225; &#192; &#193; &#194; &#195; &#196; &#197; &#198; &#199; &#200; &#201; &#202; &#203; &#204; &#205; &#206; &#207; &#208; &#209; &#210; &#211; &#212; &#213; &#214; &#216; &#338; &#352; &#217; &#218; &#219; &#220; &#221; &#376; &#222; &#224; &#225; &#226; &#227; &#228; &#229; &#230; &#231; &#232; &#233; &#234; &#235; &#236; &#237; &#238; &#239; &#240; &#241; &#242; &#243; &#244; &#245; &#246; &#248; &#339; &#353; &#249; &#250; &#251; &#252; &#253; &#254; &#255; &#913; &#914; &#915; &#916; &#917; &#918; &#919; &#920; &#921; &#922; &#923; &#924; &#925; &#926; &#927; &#928; &#929; &#931; &#932; &#933; &#934; &#935; &#936; &#937; &#945; &#946; &#947; &#948; &#949; &#950; &#951; &#952; &#953; &#954; &#955; &#956; &#957; &#958; &#959; &#960; &#961; &#962; &#963; &#964; &#965; &#966; &#967; &#968; &#969; &#8501; &#982; &#8476; &#977; &#978; &#8472; &#8465; &#8592; &#8593; &#8594; &#8595; &#8596; &#8629; &#8656; &#8657; &#8658; &#8659; &#8660; &#8756; &#8834; &#8835; &#8836; &#8838; &#8839; &#8853; &#8855; &#8869; &#8901; &#8968; &#8969; &#8970; &#8971; &#9001; &#9002; &#9674; &#9824; &#9827; &#9829; &#9830;"
,init:function(){function n(r){r<e.editables.length&&(t.getOverlayForEditable(e.editables[r]),setTimeout(function(){n(r+1)},100))}var t=this;typeof e.settings.plugins!="undefined"&&typeof e.settings.plugins.characterpicker!="undefined"&&(t.settings=e.settings.plugins.characterpicker),this._characterPickerButton=r.adopt("characterPicker",i,{tooltip:u.t("button.addcharacter.tooltip"),icon:"aloha-icon-characterpicker",scope:"Aloha.continuoustext",click:function(){!1!==t.characterOverlay&&(c=e.Selection.rangeObject,t.characterOverlay.show(this.element))}}),setTimeout(function(){n(0)},100),e.bind("aloha-editable-activated",function(e,n){t.characterOverlay=t.getOverlayForEditable(n.editable),t.characterOverlay?t._characterPickerButton.show():t._characterPickerButton.hide()}),o.sub("aloha.floating.changed",function(e){t.characterOverlay.offset=e.position.offset,t.characterOverlay.$node.css(p(t.characterOverlay,t._characterPickerButton.element))})},getOverlayForEditable:function(e){var n=this,r=
this.getEditableConfig(e.obj),i;return r?(t.isArray(r)&&(r=r.join(" ")),i=l[r],i||(i=new h(d),i.setCharacters(r),l[r]=i),i):!1}})})