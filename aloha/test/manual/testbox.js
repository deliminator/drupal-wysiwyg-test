require(["../unit/testutils"],function(e){Aloha.ready(function(){function t(){for(var e=0;e<b.length;e++)h.append('<option value="'+b[e]+'">'+b[e]+"</option>");var t=Aloha.require("aloha/floatingmenu");t.doLayout=function(){this.hide()},l.aloha(),n()}function n(){f.change(function(){v=!0}),a(i),l.contentEditableSelectionChange(function(){i();var e=Aloha.getSelection().getRangeAt(0);w=Aloha.createRange(),w.setStart(e.startContainer,e.startOffset),w.setEnd(e.endContainer,e.endOffset)}),d.click(function(){l[0].innerHTML=f.val(),Aloha.editables[0].obj.focus(),u(l)}),a("[name=engine]").change(function(){a(this).val()=="aloha"?(l.aloha(),m=Aloha):(l.mahalo().contentEditable(!0),m=document),r()}),h.change(r),a("#command-execute").click(function(){var t=h.val(),n=p.val();if(!t){alert("Please select a valid command and try again.");return}Aloha.editables[0].obj.focus(),e.addBrackets(g),u(l),m.execCommand(t,!1,n)})}function r(){var e=h.val(),t;if(!g)return;if(!e){a("#aloha-query").hide();return}a
("#aloha-query").show(),a("#aloha-indeterm").show(),a("#aloha-state").show(),a("#aloha-value").show();var n=Aloha.createRange();n.setStart(g.startContainer,g.startOffset),n.setEnd(g.endContainer,g.endOffset),Aloha.getSelection().removeAllRanges(),Aloha.getSelection().addRange(n);try{t=m.queryCommandIndeterm(e)}catch(r){r==="INVALID_ACCESS_ERR"&&a("#aloha-indeterm").hide()}a("#aloha-indeterm-result").html(t?"true":"false");try{t=m.queryCommandState(e)}catch(r){r==="INVALID_ACCESS_ERR"&&a("#aloha-state").hide()}a("#aloha-state-result").html(t?"true":"false");try{t=m.queryCommandValue(e)}catch(r){r==="INVALID_ACCESS_ERR"&&a("#aloha-value").hide()}a("#aloha-value-result").html(t)}function i(t){clearTimeout(y);if(t&&t.shiftKey)return;v&&(l[0].innerHTML=f.val(),u(l),v=!1);var n=s();if(n){var r=a([n.startContainer,n.endContainer]);if(r.length==0)return;if(!r.is(l)){var i=r.parent();if(!i.is(l)&&i.parents("#"+l.attr("id")).length==0)return}var o=0;a.browser.msie&&(o=200),y=setTimeout(function()
{e.addBrackets(n),u(l)},o)}}function s(){try{return Aloha.getSelection().getRangeAt(0)}catch(e){return null}}function o(e){e&&e.length&&e.html(e.html().replace(/\{|\[|(data\-(start|end)\s*=\s*[\"\'][^\"\']*[\"\'])|\}|\]/g,""))}function u(t){c.val(l.html());var n=a("<div>").text(l.html()).html();n=t.html();var i=n.match(/\{|\[|data\-start/g),s=n.match(/\}|\]|data\-end/g),u=0;i&&i.length&&(u+=i.length),s&&s.length&&(u+=s.length);if(u==1)Aloha.Console.warn("Collapsed selection at end of node: "),Aloha.Console.warn(getRange()),o(t);else if(u==2){var f=e.addRange(t),h=Aloha.getSelection();h.removeAllRanges(),h.addRange(f),g=f,r()}else o(t)}var a=Aloha.jQuery,f=a("#aloha-fill"),l=a("#aloha-test"),c=a("#aloha-source"),h=a("#command"),p=a("#command-value"),d=a("#testbox-fill"),v=!0,m=Aloha,g,y,b=Aloha.querySupportedCommands().sort(),w;t()})})